<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Ogani Template">
    <meta name="keywords" content="Ogani, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Nana</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;600;900&display=swap" rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="/css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="/css/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="/css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
    <!-- Page Preloder -->
    <div id="preloder">
        <div class="loader"></div>
    </div>

    <!-- Humberger Begin -->
    <div class="humberger__menu__overlay"></div>
    <%- include('../layout/humberger') %>
    <!-- Humberger End -->

    <!-- Header Section Begin -->
    <%- include('../layout/header') %>
    <!-- Header Section End -->

    <!-- Hero Section Begin -->
    <section class="hero hero-normal">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <%- include('../layout/hero_cate') %>
                </div>
                <div class="col-lg-9">
                    <%- include('../layout/search') %>
                </div>
            </div>
        </div>
    </section>
    <!-- Hero Section End -->

    <!-- Breadcrumb Section Begin -->
    <%- include('../layout/breadcrumb') %>
    <!-- Breadcrumb Section End -->

    <!-- Product Details Section Begin -->
    <section class="product-details spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <div class="product__details__pic">
                        <img class="product__details__pic__item--large" src="<%= product.imageUrl %>" alt="<%= product.name %>">
                        <div class="product__details__pic__slider owl-carousel">
                            <% if (product.additionalImages && JSON.parse(product.additionalImages).length > 0) { %>
                                <% JSON.parse(product.additionalImages).forEach(image => { %>
                                    <img data-imgbigurl="<%= image %>" src="<%= image %>" alt="<%= product.name %>">
                                <% }) %>
                            <% } %>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6">
                    <div class="product__details__text">
                        <h3><%= product.name %></h3>
                        <div class="product__details__price">$<%= product.price %></div>
                        
                        <div class="product__details__quantity">
                            <form>
                                <input type="hidden" name="productId" value="<%= product.id %>">
                                <div class="quantity">
                                    <div class="pro-qty">
                                        <input type="number" name="quantity" value="1" min="1">
                                    </div>
                                </div>
                                <button type="button" class="primary-btn add-to-cart-btn" data-product-id="<%= product.id %>">THÊM VÀO GIỎ</button>
                            </form>
                        </div>
                        
                        
                        <a href="#" class="add-to-wishlist" data-product-id="<%= product.id %>">
                            <i class="icon_heart_alt"></i>
                        </a>
                        <ul>
                            <li><b>Tình trạng:</b> <span><%= product.availability %></span></li>
                            <li><b>Chiều cao:</b> <span><%= product.height ? product.height + "cm" : "N/A" %></span></li>
                            <li><b>Danh mục:</b> <span><%= product.category ? product.category.name : "Chưa phân loại" %></span></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="product__details__tab">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#tabs-1" role="tab" aria-selected="true">Thông tin</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tabs-3" role="tab" aria-selected="false">Đánh giá (<span id="review-count">0</span>)</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="tabs-1" role="tabpanel">
                                <div class="product__details__tab__desc">
                                    <p><%= product.description %></p>
                                </div>
                            </div>

                            <div class="tab-pane" id="tabs-3" role="tabpanel" data-product-id="<%= product.id %>">
                                <div class="product__details__tab__desc">
                                    <h6>Đánh giá sản phẩm</h6>
                                    <div id="reviews-list">
                                        <!-- Reviews will be loaded here by JavaScript -->
                                        <p>Chưa có đánh giá nào cho sản phẩm này.</p>
                                    </div>
                                    <% if (userLogin) { %>
                                        <div class="review-form mt-4">
                                            <h5>Gửi đánh giá của bạn</h5>
                                            <form id="submit-review-form">
                                                <div class="form-group">
                                                    <label for="rating">Đánh giá sao:</label>
                                                    <div class="rating-stars">
                                                        <input type="radio" id="star5" name="rating" value="5" required><label for="star5" title="5 sao"></label>
                                                        <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 sao"></label>
                                                        <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 sao"></label>
                                                        <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 sao"></label>
                                                        <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 sao"></label>
                                                    </div>
                                                </div>
                                                <div class="form-group mt-3">
                                                    <label for="comment">Bình luận:</label>
                                                    <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
                                                </div>
                                                <button type="submit" class="site-btn mt-3">Gửi đánh giá</button>
                                            </form>
                                        </div>
                                    <% } else { %>
                                        <p class="mt-4">Vui lòng <a href="/login">đăng nhập</a> để gửi đánh giá.</p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Product Details Section End -->

    <!-- Related Product Section Begin -->
    <section class="related-product">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-title related__product__title">
                        <h2>Sản phẩm liên quan</h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <% if (relatedProducts && relatedProducts.length > 0) { %>
                    <% relatedProducts.forEach(relatedProduct => { %>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <div class="product__item">
                                <div class="product__item__pic set-bg">
                                    <img src="<%= relatedProduct.imageUrl %>" alt="<%= relatedProduct.name %>" class="img-fluid">
                                    <ul class="product__item__pic__hover">
                                        <li><a href="#"><i class="fa fa-heart"></i></a></li>
                                        <li><a href="/shop-details/<%= relatedProduct.id %>"><i class="fa fa-shopping-cart"></i></a></li>
                                    </ul>
                                </div>
                                <div class="product__item__text">
                                    <h6><a href="/shop-details/<%= relatedProduct.id %>"><%= relatedProduct.name %></a></h6>
                                    <h5>$<%= relatedProduct.price %></h5>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p>Không tìm thấy sản phẩm liên quan.</p>
                <% } %>
            </div>
        </div>
    </section>
    <!-- Related Product Section End -->

    <!-- Footer Section Begin -->
    <%- include('../layout/footer_f') %>
    <!-- Footer Section End -->

    <!-- Js Plugins -->
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/jquery.nice-select.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/jquery.slicknav.js"></script>
    <script src="/js/mixitup.min.js"></script>
    <script src="/js/owl.carousel.min.js"></script>
    <script src="/js/main.js"></script>
    <script>
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault(); // Ngăn hành vi mặc định
    
                const productId = this.getAttribute('data-product-id');
                const quantityInput = document.querySelector('input[name="quantity"]');
                const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
    
                // Gửi yêu cầu AJAX để thêm sản phẩm vào giỏ hàng
                fetch('/shoping-cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, quantity }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                        window.location.reload();
                        } else {
                            alert(data.message); // Thông báo lỗi nếu có
                        }
                    })
                    .catch(error => console.error('Error:', error));
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            $(".product__details__pic__slider").owlCarousel({
                loop: true,
                margin: 10,
                nav: true,
                items: 1,
                dots: true,
            });
        });
    </script>
    <script>
        document.querySelectorAll('.add-to-wishlist').forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault(); // Ngăn hành vi mặc định của thẻ <a>
    
                const productId = this.getAttribute('data-product-id');
                console.log("Product ID:", productId);
    
                // Gửi yêu cầu AJAX để thêm sản phẩm vào danh sách yêu thích
                fetch('/wishlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId }), // Gửi ID sản phẩm
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Cập nhật số lượng sản phẩm trong icon wishlist
                            const wishlistCountElement = document.querySelector('.header__cart ul li:nth-child(1) span');
                            if (wishlistCountElement) wishlistCountElement.textContent = data.wishlistCount;
    
                            alert(data.message);
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            });
        });
    </script>
    <script>
        // JavaScript cho phần đánh giá sản phẩm
        document.addEventListener('DOMContentLoaded', function() {
            const reviewTab = document.getElementById('tabs-3');
            const productId = reviewTab ? reviewTab.dataset.productId : null;
            const reviewsListDiv = document.getElementById('reviews-list');
            const reviewCountSpan = document.getElementById('review-count');
            const submitReviewForm = document.getElementById('submit-review-form');

            async function fetchReviews() {
                if (!productId) {
                    reviewsListDiv.innerHTML = `<p>Không thể tải đánh giá do thiếu ID sản phẩm.</p>`;
                    return;
                }
                try {
                    const response = await fetch(`/api/products/${productId}/reviews`);
                    const data = await response.json();

                    if (data.success) {
                        displayReviews(data.reviews);
                        reviewCountSpan.textContent = data.reviews.length;
                    } else {
                        reviewsListDiv.innerHTML = `<p>${data.message || 'Không thể tải đánh giá.'}</p>`;
                    }
                } catch (error) {
                    console.error('Error fetching reviews:', error);
                    reviewsListDiv.innerHTML = `<p>Đã xảy ra lỗi khi tải đánh giá.</p>`;
                }
            }

            function displayReviews(reviews) {
                if (reviews.length === 0) {
                    reviewsListDiv.innerHTML = `<p>Chưa có đánh giá nào cho sản phẩm này.</p>`;
                    return;
                }

                reviewsListDiv.innerHTML = ''; // Clear previous reviews
                reviews.forEach(review => {
                    const reviewElement = document.createElement('div');
                    reviewElement.classList.add('single-review', 'mb-3', 'pb-3', 'border-bottom');
                    
                    const starsHtml = Array(review.rating).fill('<i class="fa fa-star text-warning"></i>').join('') +
                                      Array(5 - review.rating).fill('<i class="fa fa-star-o text-secondary"></i>').join('');

                    reviewElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${review.user.email}</h6>
                            <small class="text-muted">${new Date(review.createdAt).toLocaleDateString('vi-VN')}</small>
                        </div>
                        <div class="rating mb-2">
                            ${starsHtml}
                        </div>
                        <p>${review.comment || ''}</p>
                        ${review.adminReply ? `
                            <div class="admin-reply mt-2 ml-4 p-2" style="background-color: #f8f9fa; border-left: 3px solid #007bff;">
                                <strong>Phản hồi từ cửa hàng:</strong>
                                <p class="mb-0">${review.adminReply}</p>
                            </div>
                        ` : ''}
                    `;
                    reviewsListDiv.appendChild(reviewElement);
                });
            }

            if (submitReviewForm) {
                submitReviewForm.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    const rating = document.querySelector('input[name="rating"]:checked');
                    const comment = document.getElementById('comment').value;

                    if (!rating) {
                        alert('Vui lòng chọn số sao đánh giá.');
                        return;
                    }

                    try {
                        const response = await fetch('/api/reviews', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                productId: productId,
                                rating: parseInt(rating.value),
                                comment: comment
                            })
                        });
                        const data = await response.json();

                        if (data.success) {
                            alert(data.message);
                            submitReviewForm.reset(); // Reset form
                            fetchReviews(); // Tải lại đánh giá để hiển thị đánh giá mới
                        } else {
                            alert(data.message || 'Gửi đánh giá thất bại.');
                        }
                    } catch (error) {
                        console.error('Error submitting review:', error);
                        alert('Đã xảy ra lỗi khi gửi đánh giá.');
                    }
                });
            }

            // Tải đánh giá khi trang được tải
            fetchReviews();
        });
    </script>
    <!-- Simple Star Rating CSS -->
    <style>
        .rating-stars {
            display: inline-block;
            direction: rtl; /* Đảo ngược thứ tự để sao 5 ở bên phải */
        }
        .rating-stars input[type="radio"] {
            display: none;
        }
        .rating-stars label {
            color: #ccc; /* Màu sao chưa chọn */
            font-size: 25px;
            padding: 0 5px;
            cursor: pointer;
        }
        .rating-stars label:hover,
        .rating-stars label:hover ~ label,
        .rating-stars input[type="radio"]:checked ~ label {
            color: #ffc107; /* Màu sao đã chọn/hover */
        }
        .rating-stars label:before {
            content: '\2605'; /* Ký tự ngôi sao */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>

</html>