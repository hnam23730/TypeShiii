<style>
    /* CSS for Search Autocomplete */
    .hero__search {
        overflow: visible !important;
        z-index: 1000;
        position: relative;
    }

    .hero__search__form {
        position: relative;
        z-index: 1001; /* Đảm bảo form tìm kiếm nằm trên các phần tử khác như banner */
    }

    .search-results {
        display: none; /* Hidden by default */
        position: absolute;
        top: 100%; /* Position it right below the form */
        left: 0;
        right: 0;
        background-color: #ffffff;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 99999;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 5px;
        max-height: 300px;
        overflow-y: auto;
    }

    .search-results a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #f1f1f1;
    }

    .search-results a:last-child {
        border-bottom: none;
    }

    .search-results a:hover {
        background-color: #f1f1f1;
    }

    .search-result-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        margin-right: 12px;
        border-radius: 4px;
        border: 1px solid #eee;
    }

    .search-result-info {
        display: flex;
        flex-direction: column;
    }

    .search-result-price {
        color: #ee4d2d; /* Shopee's orange color */
        font-size: 0.9em;
        margin-top: 4px;
    }
</style>

<div class="hero__search">
    <div class="hero__search__form">
        <form action="/shop.grid" method="GET">
            <input type="text" id="product-search-input" name="query" placeholder="Bạn cần tìm gì?" autocomplete="off">
            <button type="submit" class="site-btn">TÌM</button>
        </form>
        <div id="search-results-container" class="search-results"></div>
    </div>
    <div class="hero__search__phone">
        <div class="hero__search__phone__icon">
            <i class="fa fa-phone"></i>
        </div>
        <div class="hero__search__phone__text">
            <h5>+84 12.345.678</h5>
            <span>hỗ trợ 24/7</span>
        </div>
    </div>
</div>

<script>
    // Use a self-executing function to avoid polluting the global scope
    (function() {
        const searchInput = document.getElementById('product-search-input');
        const searchResultsContainer = document.getElementById('search-results-container');
        const searchFormContainer = document.querySelector('.hero__search__form');

        if (!searchInput || !searchResultsContainer || !searchFormContainer) {
            console.error('Search elements not found in search.ejs. Search will not work.');
            return;
        }

        let debounceTimer;
        const debounce = (callback, time) => {
            window.clearTimeout(debounceTimer);
            debounceTimer = window.setTimeout(callback, time);
        };

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();

            if (query.length < 1) {
                searchResultsContainer.innerHTML = '';
                searchResultsContainer.style.display = 'none';
                return;
            }

            // Use debouncing
            debounce(async () => {
                try {
                    // Correct endpoint and query parameter
                    const response = await fetch(`/search?query=${encodeURIComponent(query)}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const products = await response.json();
                    searchResultsContainer.innerHTML = '';

                    if (products.length > 0) {
                        products.forEach(product => {
                            const link = document.createElement('a');
                            link.href = `/shop-details/${product.id}`;

                            // Product Image
                            const img = document.createElement('img');
                            img.src = product.imageUrl || '/img/default-product.png'; // Use a fallback image
                            img.alt = product.name;
                            img.className = 'search-result-img';
                            link.appendChild(img);

                            // Product Info (Name + Price)
                            const infoDiv = document.createElement('div');
                            infoDiv.className = 'search-result-info';

                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = product.name;
                            infoDiv.appendChild(nameSpan);

                            const priceSpan = document.createElement('span');
                            priceSpan.className = 'search-result-price';
                            // Ensure price is a number and format it
                            priceSpan.textContent = `$${parseFloat(product.price || 0).toFixed(2)}`;
                            infoDiv.appendChild(priceSpan);

                            link.appendChild(infoDiv);
                            searchResultsContainer.appendChild(link);
                        });
                    } else {
                        const noResult = document.createElement('div');
                        noResult.style.cssText = 'padding: 12px 16px; color: #777;';
                        noResult.textContent = 'Không tìm thấy sản phẩm nào';
                        searchResultsContainer.appendChild(noResult);
                    }
                    searchResultsContainer.style.display = 'block';
                } catch (error) {
                    console.error('Lỗi khi tìm kiếm:', error);
                    searchResultsContainer.style.display = 'none';
                }
            }, 300);
        });

        // Show results again when focusing on the input if it has content
        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 1) {
                this.dispatchEvent(new Event('input'));
            }
        });

        // Hide results when clicking outside
        document.addEventListener('click', function(event) {
            if (!searchFormContainer.contains(event.target)) {
                searchResultsContainer.style.display = 'none';
            }
        });
    })();
</script>