<nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

    <!-- Sidebar Toggle (Topbar) -->
    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
        <i class="fa fa-bars"></i>
    </button>

    <!-- Topbar Navbar -->
    <ul class="navbar-nav ml-auto">

        <!-- Nav Item - Search Dropdown (Visible Only XS) -->
        <li class="nav-item dropdown no-arrow d-sm-none">
            <a class="nav-link dropdown-toggle" href="#" id="searchDropdown" role="button"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-search fa-fw"></i>
            </a>
            <!-- Dropdown - Messages -->
            <div class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
                aria-labelledby="searchDropdown">
                <form class="form-inline mr-auto w-100 navbar-search">
                    <div class="input-group">
                        <input type="text" class="form-control bg-light border-0 small"
                            placeholder="Search for..." aria-label="Search"
                            aria-describedby="basic-addon2">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button">
                                <i class="fas fa-search fa-sm"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </li>

        <!-- Nav Item - Messages -->
        <li class="nav-item dropdown no-arrow mx-1">
            <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-envelope fa-fw"></i>
                <!-- Counter - Messages -->
                <span class="badge badge-danger badge-counter" id="notification-count">0</span>
            </a>
            <!-- Dropdown - Messages -->
            <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in" id="notification-list"
                aria-labelledby="notificationDropdown">
                <h6 class="dropdown-header">
                    Trung tâm thông báo
                </h6>
                <span class="dropdown-item dropdown-header">Không có thông báo mới</span>
            </div>
        </li>

        <div class="topbar-divider d-none d-sm-block"></div>

        <!-- Nav Item - User Information -->
        <li class="nav-item dropdown no-arrow">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="mr-2 d-none d-lg-inline text-gray-600 small">
                    <% if (userLogin) { %>
                        <%= userLogin.email %>
                    <% } else { %>
                        Guest
                    <% } %>
                </span>
                <img class="img-profile rounded-circle"
                    src="img/undraw_profile.svg">
            </a>
            <!-- Dropdown - User Information -->
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                aria-labelledby="userDropdown">

                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="/logout" data-toggle="modal" data-target="#logoutModal">
                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                    Logout
                </a>
            </div>
        </li>

    </ul>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const notificationIcon = document.getElementById('notificationDropdown');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
    
            async function fetchNotifications() {
                try {
                    const response = await fetch('/api/notifications');
                    if (!response.ok) return;
                    const data = await response.json();
    
                    if (data.success) {
                        notificationCount.textContent = data.unreadCount;
                        if (data.unreadCount > 0) {
                            notificationCount.style.display = 'inline-block';
                        } else {
                            notificationCount.style.display = 'none';
                        }
                        updateNotificationDropdown(data.notifications);
                    }
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                }
            }
    
            function updateNotificationDropdown(notifications) {
                // Clear previous items but keep the header
                while (notificationList.children.length > 1) {
                    notificationList.removeChild(notificationList.lastChild);
                }
    
                if (notifications.length === 0) {
                    notificationList.querySelector('.dropdown-header').textContent = 'Không có thông báo mới';
                    return;
                }
    
                notificationList.querySelector('.dropdown-header').textContent = `${notifications.length} Thông báo`;
    
                notifications.forEach(notif => {
                    const notifElement = document.createElement('a');
                    notifElement.href = notif.link || '#';
                    notifElement.classList.add('dropdown-item', 'd-flex', 'align-items-center');
                    notifElement.dataset.id = notif.id;
    
                    const iconClass = notif.type === 'new_order' ? 'fa-file-alt' : 'fa-comment-alt';
    
                    notifElement.innerHTML = `
                        <div class="mr-3">
                            <div class="icon-circle bg-primary">
                                <i class="fas ${iconClass} text-white"></i>
                            </div>
                        </div>
                        <div>
                            <div class="small text-gray-500">${new Date(notif.createdAt).toLocaleDateString('vi-VN')}</div>
                            <span class="font-weight-bold">${notif.message}</span>
                        </div>
                    `;
                    notifElement.addEventListener('click', handleNotificationClick);
                    notificationList.appendChild(notifElement);
                });

                if (notifications.length > 0) {
                    const divider = document.createElement('div');
                    divider.classList.add('dropdown-divider');
                    notificationList.appendChild(divider);

                    const viewAll = document.createElement('a');
                    viewAll.classList.add('dropdown-item', 'text-center', 'small', 'text-gray-500');
                    viewAll.href = '/admin/reviews'; // Liên kết chính đến trang quản lý đánh giá
                    viewAll.textContent = 'Xem tất cả Đánh giá';
                    notificationList.appendChild(viewAll);
                }
            }

            async function handleNotificationClick(event) {
                const notifId = event.currentTarget.dataset.id;
                try {
                    // Gửi yêu cầu đánh dấu đã đọc mà không cần chờ đợi
                    fetch(`/api/notifications/${notifId}/read`, { method: 'POST' });
                } catch (error) {
                    console.error('Failed to mark notification as read:', error);
                }
            }
    
            // Fetch notifications every 30 seconds
            fetchNotifications();
            setInterval(fetchNotifications, 30000);
        });
    </script>
</nav>